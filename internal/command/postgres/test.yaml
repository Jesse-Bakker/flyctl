name: Postgres Rolling Restart
require_lease: true
constraints: 
  app_role_id: "postgres_cluster"
  platform_version: "machines"
  images: 
  - repository: "flyio/postgres"
    min_fly_version: "0.0.20"
  - repository: "flyio/postgres-standalone"
operations:
  - name: restart
    type: flaps
    flaps_command: 
      action: restart
      method: POST
    selector:
      health_check:
        role: replica
    wait_for_health_checks: true

  - name: failover
    type: http
    http_command:
      method: GET
      endpoint: "/commands/admin/failover/trigger"
      port: 5500
    selector: 
      health_check:
        role: leader

  - name: restart
    type: flaps
    flaps_command: 
      action: restart
      method: POST
    selector:
      health_check:
        role: leader
      preprocess: true
    wait_for_health_checks: true


---
name: Rolling Restart
require_lease: true
operations:
  - name: restart
    type: flaps
    flaps_command: 
      action: restart
      method: POST
    wait_for_health_checks: true